<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityInsight - Panel de Gestión Municipal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Estilos Generales */
        :root {
            --primary-color: #5d9cec;
            /* Azul más suave */
            --secondary-color: #48cfad;
            /* Verde más suave */
            --accent-color: #a0d468;
            /* Nuevo color de acento */
            --background-light: #ecf0f1;
            /* Gris claro */
            --background-dark: #2c3e50;
            /* Azul oscuro */
            --text-light: #2c3e50;
            /* Gris oscuro para texto (más oscuro para contraste) */
            --text-dark: #ecf0f1 ;
            /* Texto claro para modo oscuro */
            --card-background-light-glass: rgba(255, 255, 255, 0.85);
            /* Blanco semi-transparente (más opaco) */
            --card-background-dark-glass: rgba(59, 80, 98, 0.85);
            /* Oscuro semi-transparente (más opaco) */
            --border-color-light-glass: rgba(255, 255, 255, 0.6);
            /* Borde blanco transparente (más visible) */
            --border-color-dark-glass: rgba(74, 98, 115, 0.6);
            /* Borde oscuro transparente (más visible) */
            --shadow-light: rgba(0, 0, 0, 0.2);
            /* Sombra más pronunciada */
            --shadow-dark: rgba(0, 0, 0, 0.7);
            /* Sombra más oscura */
            --blur-amount: 20px;
            /* Mayor desenfoque para el glassmorfismo */
        }

        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.5s ease, color 0.5s ease;
            display: flex;
            min-height: 100vh;
            /* Gradiente de fondo para efecto glassmorfismo */
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--background-light) 100%);
            overflow-x: hidden;
            /* Evitar scroll horizontal */
        }

        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--background-dark) 0%, #1e2b38 100%);
        }

        /* Estilos de la Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--background-dark);
            /* Sólido para mejor legibilidad */
            color: var(--text-dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 25px var(--shadow-dark);
            /* Sombra más fuerte */
            flex-shrink: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.25);
            /* Borde sutil */
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            /* Sombra de texto */
        }

        .sidebar-header h2 {
            font-size: 24px;
            /* Ajustado para que no sobresalga */
        }

        .sidebar-header i {
            margin-right: 15px;
            color: var(--secondary-color);
            font-size: 24px;
            /* Ajustado para que no sobresalga */
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 14px;
            /* Más redondeado */
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .sidebar-nav li:hover,
        .sidebar-nav li.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(10px);
            /* Mayor movimiento al pasar el ratón */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            /* Sombra en el hover */
        }

        .sidebar-nav li i {
            margin-right: 15px;
            font-size: 18px;
        }

        .sidebar-nav a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            text-align: center;
            font-size: 14px;
            opacity: 0.9;
        }

        .sidebar-footer i {
            margin-right: 8px;
            color: var(--accent-color);
        }

        /* Estilos del Contenido Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .logo-text {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text img {
            height: 50px;
            border-radius: 14px;
            /* Más redondeado */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        /* Eliminado: h1 y p.subtitle de la cabecera, ya que el nombre ya está en el menú */
        .logo-text h1,
        .subtitle {
            display: none;
        }

        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .theme-toggle-container button {
            background-color: var(--card-background-light-glass);
            border: 1px solid var(--border-color-light-glass);
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 18px var(--shadow-light);
            color: var(--text-light);
            backdrop-filter: blur(var(--blur-amount));
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .theme-toggle-container button {
            background-color: var(--card-background-dark-glass);
            border-color: var(--border-color-dark-glass);
            box-shadow: 0 5px 18px var(--shadow-dark);
            color: var(--text-dark);
        }

        .theme-toggle-container button:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 25px var(--shadow-light);
        }

        body.dark-mode .theme-toggle-container button:hover {
            box-shadow: 0 10px 25px var(--shadow-dark);
        }

        .section-title {
            font-size: 1.9em;
            /* Ligeramente más grande */
            margin-bottom: 25px;
            color: var(--text-light);
            /* Cambiado a text-light para mejor contraste */
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .section-title {
            color: var(--text-dark);
            /* Texto claro en modo oscuro */
        }

        .section-title i {
            color: var(--text-light);
            /* Icono con primary-color */
            font-size: 1.25em;
        }

        body.dark-mode .section-title i {
            color: var(--text-dark);
            /* Texto claro en modo oscuro */
            font-size: 1.25em;
        }

        /* Sección de KPIs */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 28px;
            /* Espacio ligeramente mayor */
            margin-bottom: 40px;
        }

        .kpi-card {
            background-color: var(--card-background-light-glass);
            border-radius: 22px;
            padding: 20px; /* Reduced padding for smaller height */
            box-shadow: 0 12px 45px var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px; /* Reduced gap for smaller height */
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, border 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(var(--blur-amount));
            min-height: 180px; /* Adjusted min-height for smaller size */
            justify-content: space-between; /* Distribute content within the card */
        }

        body.dark-mode .kpi-card {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 12px 45px var(--shadow-dark);
            border: 1px solid var(--border-color-dark-glass);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 12px;
            /* Borde más ancho */
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            border-radius: 22px 0 0 22px;
        }

        .kpi-card:hover {
            transform: translateY(-12px) rotateZ(1deg);
            box-shadow: 0 18px 60px var(--shadow-light);
        }

        body.dark-mode .kpi-card:hover {
            box-shadow: 0 18px 60px var(--shadow-dark);
        }

        .kpi-card .card-icon {
            font-size: 3em; /* Slightly smaller icon */
            color: var(--primary-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
            margin-bottom: 0; /* Reduced margin */
        }

        .kpi-content {
            flex-grow: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .kpi-content h3 {
            font-size: 1.3em; /* Slightly smaller heading */
            margin-bottom: 3px; /* Reduced margin */
            color: var(--text-light);
        }

        body.dark-mode .kpi-content h3 {
            color: var(--text-dark);
        }

        .kpi-value {
            font-size: 2.4em; /* Slightly smaller value */
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px; /* Reduced margin */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            font-size: 1em; /* Slightly smaller trend text */
            font-weight: 600;
            opacity: 0.95;
            margin-bottom: 12px; /* Reduced margin */
        }

        .kpi-trend.positive {
            color: var(--secondary-color);
        }

        .kpi-trend.negative {
            color: #e74c3c;
        }

        .kpi-trend i {
            margin-right: 8px; /* Reduced space */
        }

        .kpi-info-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px; /* Reduced padding */
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em; /* Slightly smaller font */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            text-align: center;
        }

        .kpi-info-btn:hover {
            background-color: #4a8ddc;
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.4);
        }

        /* Sección de Pestañas */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.15);
            /* Borde más suave */
            gap: 15px;
        }

        body.dark-mode .tabs {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .tab {
            background-color: transparent;
            border: none;
            padding: 12px 20px;
            font-size: 1.15em;
            /* Ligeramente más grande */
            font-weight: 600;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s ease, border-bottom 0.3s ease;
            position: relative;
        }

        body.dark-mode .tab {
            color: var(--text-dark);
        }

        .tab::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 3px;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        .tab.active {
            color: var(--primary-color);
            text-shadow: 0 0 8px rgba(93, 156, 236, 0.6);
            /* Resplandor al activar más fuerte */
        }

        .tab.active::after {
            background-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            padding-top: 20px;
            animation: fadeIn 1s ease forwards;
        }

        .tab-content.active {
            display: block;
        }

        /* Estilos del Chatbot */
        .chat-container {
            background-color: var(--card-background-light-glass);
            border-radius: 22px;
            /* Más redondeado */
            box-shadow: 0 12px 45px var(--shadow-light);
            display: flex;
            flex-direction: column;
            height: 700px; /* Increased height */
            width: 85%; /* Changed to 80% */
            max-width: 900px; /* Max-width adjusted */
            margin: 0 auto; /* Centered */
            overflow: hidden;
            border: 1px solid var(--border-color-light-glass);
            backdrop-filter: blur(var(--blur-amount));
        }

        body.dark-mode .chat-container {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 12px 45px var(--shadow-dark);
            border: 1px solid var(--border-color-dark-glass);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .chat-messages {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .message {
            max-width: 85%;
            /* Ligeramente más ancho */
            padding: 14px 20px;
            /* Más padding */
            border-radius: 22px;
            line-height: 1.6;
            /* Mayor interlineado */
            word-wrap: break-word;
            font-size: 1em;
            /* Ligeramente más grande */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            /* Sombra sutil para mensajes */
        }

        .user-message {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 10px;
            /* Borde más suave */
        }

        .ai-message {
            background-color: rgba(230, 230, 230, 0.8);
            /* Más claro, más transparente */
            color: var(--text-light);
            align-self: flex-start;
            border-bottom-left-radius: 10px;
            /* Borde más suave */
        }

        body.dark-mode .ai-message {
            background-color: rgba(70, 90, 110, 0.8);
            /* Más oscuro, más transparente */
            color: var(--text-dark);
        }

        .chat-input {
            display: flex;
            padding: 18px 22px;
            /* Mayor padding */
            gap: 12px;
            /* Mayor espacio */
            align-items: center;
            position: relative; /* Needed for tooltip positioning */
        }

        .chat-input .ai-avatar {
            width: 40px; /* Size of the AI avatar */
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            cursor: pointer; /* Indicate it's interactive */
            transition: transform 0.3s ease-out; /* Smooth transition for rotation */
        }

        .chat-input .ai-avatar.spinning {
            animation: spin-pause-spin-ai-avatar 2.4s linear infinite; /* New animation */
        }

        @keyframes spin-pause-spin-ai-avatar {
            0% { transform: rotate(0deg); }
            40% { transform: rotate(360deg); } /* Complete first spin */
            60% { transform: rotate(360deg); } /* Pause */
            100% { transform: rotate(720deg); } /* Complete second spin */
        }

        .ai-avatar-tooltip {
            position: absolute;
            bottom: calc(100% + 10px); /* Position above the avatar */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10; /* Ensure it's above other elements */
        }

        .chat-input:hover .ai-avatar-tooltip {
            opacity: 1;
            visibility: visible;
        }


        .chat-input input {
            flex-grow: 1;
            padding: 14px 22px;
            /* Mayor padding */
            border: 1px solid rgba(0, 0, 0, 0.2);
            /* Borde más suave */
            border-radius: 35px;
            /* Más redondeado */
            font-size: 1.05em;
            /* Ligeramente más grande */
            outline: none;
            background-color: rgba(255, 255, 255, 0.5);
            /* Input transparente */
            color: var(--text-light);
            transition: border-color 0.3s ease, background-color 0.3s ease;
            backdrop-filter: blur(10px);
            /* Desenfoque sutil para input */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .chat-input input {
            background-color: rgba(50, 70, 90, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-dark);
        }

        .chat-input input:focus {
            border-color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2), 0 0 8px rgba(93, 156, 236, 0.4);
        }

        body.dark-mode .chat-input input:focus {
            background-color: rgba(50, 70, 90, 0.9);
        }

        .chat-input button {
            background-color: var(--background-light);
            color: var(--text-light);
            border: none;
            border-radius: 35px;
            /* Más redondeado */
            padding: 14px 25px;
            /* Mayor padding */
            cursor: pointer;
            font-size: 1.15em;
            /* Ligeramente más grande */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .chat-input button:hover {
            background-color: var(--background-dark);
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.4);
        }

        .chat-input button img {
            width: 24px; /* Icon size */
            height: 24px;

        }


        /* Análisis de Barrio */
        .neighborhood-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 25px;
            /* Más espacio */
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .neighborhood-card {
            background-color: var(--card-background-light-glass);
            border-radius: 22px;
            /* Más redondeado */
            padding: 22px;
            /* Más padding */
            text-align: center;
            box-shadow: 0 12px 45px var(--shadow-light);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease, background-color 0.3s ease;
            border: 1px solid var(--border-color-light-glass);
            backdrop-filter: blur(var(--blur-amount));
        }

        body.dark-mode .neighborhood-card {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 12px 45px var(--shadow-dark);
            border: 1px solid var(--border-color-dark-glass);
        }

        .neighborhood-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 18px 60px var(--shadow-light);
        }

        body.dark-mode .neighborhood-card:hover {
            box-shadow: 0 18px 60px var(--shadow-dark);
        }


        .neighborhood-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 5px var(--primary-color), 0 18px 60px var(--shadow-light);
            /* Borde de selección más grueso */
            transform: scale(1.08);
            /* Escala más pronunciada */
        }

        body.dark-mode .neighborhood-card.selected {
            box-shadow: 0 0 0 5px var(--primary-color), 0 18px 60px var(--shadow-dark);
        }

        .neighborhood-icon {
            font-size: 3.8em;
            /* Ligeramente más grande */
            margin-bottom: 12px;
            /* Más espacio */
            opacity: 0.9;
        }

        .neighborhood-card h4 {
            font-size: 1.3em;
            /* Ligeramente más grande */
            color: var(--text-light);
            font-weight: 600;
        }

        body.dark-mode .neighborhood-card h4 {
            color: var(--text-dark);
        }

        .analysis-container {
            background-color: var(--card-background-light-glass);
            border-radius: 22px;
            /* Más redondeado */
            box-shadow: 0 12px 45px var(--shadow-light);
            padding: 35px;
            /* Más padding */
            margin-bottom: 30px;
            display: none;
            animation: fadeIn 1.2s ease forwards;
            /* Fade in más lento */
            border: 1px solid var(--border-color-light-glass);
            backdrop-filter: blur(var(--blur-amount));
        }

        body.dark-mode .analysis-container {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 12px 45px var(--shadow-dark);
            border: 1px solid var(--border-color-dark-glass);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .analysis-header {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .analysis-title h3 {
            font-size: 2.1em;
            /* Ligeramente más grande */
            color: var(--text-light);
            /* Cambiado a text-light para mejor contraste */
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .analysis-title h3 {
            color: var(--text-dark);
        }

        .analysis-title p {
            font-size: 1.05em;
            color: var(--text-light);
            opacity: 0.95;
        }

        body.dark-mode .analysis-title p {
            color: var(--text-dark);
        }

        .status-badge {
            background-color: #e74c3c;
            color: white;
            padding: 12px 20px;
            /* Mayor padding */
            border-radius: 30px;
            /* Más redondeado */
            font-size: 1em;
            /* Ligeramente más grande */
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.5);
        }

        .issues-list,
        .recommendations {
            margin-bottom: 35px;
            /* Mayor espacio */
        }

        .issues-list h4,
        .recommendations h4 {
            font-size: 1.6em;
            /* Ligeramente más grande */
            color: var(--text-light);
            /* Cambiado a text-light para mejor contraste */
            margin-bottom: 18px;
            /* Más espacio */
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .issues-list h4,
        body.dark-mode .recommendations h4 {
            color: var(--text-dark);
        }

        .issue-item,
        .recommendation-item {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 18px;
            /* Más redondeado */
            padding: 22px;
            /* Mayor padding */
            margin-bottom: 18px;
            /* Más espacio */
            border: 1px solid var(--border-color-light-glass);
            display: flex;
            gap: 18px;
            /* Más espacio */
            align-items: flex-start;
            backdrop-filter: blur(10px);
            /* Desenfoque sutil */
            box-shadow: 0 6px 22px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .issue-item:hover,
        .recommendation-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }


        body.dark-mode .issue-item,
        body.dark-mode .recommendation-item {
            background-color: rgba(74, 98, 115, 0.5);
            border-color: var(--border-color-dark-glass);
        }

        .issue-item h5,
        .recommendation-text h5 {
            font-size: 1.25em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .issue-item p,
        .recommendation-text p {
            font-size: 1.1em;
            /* Ligeramente más grande */
            color: var(--text-light);
            opacity: 0.95;
        }

        body.dark-mode .issue-item p,
        body.dark-mode .recommendation-text p {
            color: var(--text-dark);
        }

        .recommendation-icon {
            background-color: var(--secondary-color);
            color: white;
            width: 45px;
            /* Más grande */
            height: 45px;
            /* Más grande */
            min-width: 45px;
            min-height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 1.4em;
            /* Texto de icono más grande */
            box-shadow: 0 3px 10px rgba(72, 207, 173, 0.5);
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(40px);
                /* Mayor desplazamiento */
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes thinkingDots {
            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .typing-indicator::after {
            content: '...';
            animation: thinkingDots 1.5s infinite steps(1);
        }

        /* Alerta de Evento */
        #event-alert {
            background-color: var(--card-background-light-glass);
            color: var(--text-light);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;

            backdrop-filter: blur(var(--blur-amount));
            max-width: 200px; /* Ajustar ancho */
            text-align: left;
            opacity: 0; /* Hidden by default for fade in */
            animation: fadeIn 1s ease 0.5s forwards; /* Delayed fade in */
            justify-content: center; /* Centrar contenido dentro de la alerta */
        }

        body.dark-mode #event-alert {
            background-color: var(--card-background-dark-glass);
            color: var(--text-dark);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color-dark-glass);
        }

        #event-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 12px;
            /* Borde más ancho */
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            border-radius: 22px 0 0 22px;
        }

        #event-alert:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        body.dark-mode #event-alert:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
        }

        .event-icon-container {
            position: relative;
            width: 40px; /* Fixed width for the image */
            height: 40px; /* Fixed height for the image */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .event-icon-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensure image fits without distortion */
            filter: grayscale(0%) saturate(200%) hue-rotate(-20deg); /* Make it reddish */
        }

        .event-date-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -30%); /* Adjust vertical position slightly */
            font-size: 0.8em; /* Slightly larger number */
            font-weight: 700;
            color: black; /* Color of the number */
            /*text-shadow: 0 0 3px rgba(0,0,0,0.5); /* Slight shadow for visibility */
        }

        #event-alert p {
            flex-grow: 1; /* Allow paragraph to take available space */
            text-align: center; /* Center the text within the paragraph */
            margin: 0; /* Remove default margin */
            font-weight: 600;
        }

        #event-alert p strong {
            color: var(--primary-color); /* Keep strong text color as primary */
        }


        /* Proceso de Pensamiento de la IA */
        .thinking-process {
            background-color: var(--card-background-light-glass);
            border-radius: 18px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color-light-glass);
            backdrop-filter: blur(var(--blur-amount));
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: fadeIn 0.5s ease forwards;
        }

        body.dark-mode .thinking-process {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color-dark-glass);
        }

        .thinking-process .icons-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .thinking-process .icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px; /* Ensure space for text and icon */
        }

        .thinking-process .icon-item i {
            font-size: 2.5em;
            color: #ccc;
            /* Blanco y negro inicial */
            filter: grayscale(100%);
            transition: color 0.5s ease, filter 0.5s ease;
        }

        .thinking-process .icon-item.colored i {
            filter: grayscale(0%);
            color: var(--secondary-color); /* Color when active */
        }

        .thinking-process .icon-item p {
            font-size: 0.9em;
            margin-top: 5px;
            color: var(--text-light);
            opacity: 0.8;
        }

        body.dark-mode .thinking-process .icon-item p {
            color: var(--text-dark);
        }

        .thinking-message {
            background: linear-gradient(90deg, #6c5ce7, #00cec9);
            /* Gradiente vibrante */
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            width: 80%;
            text-align: center;
            animation: siri-wave-animation 3s infinite alternate;
        }

        @keyframes colorize-icon {
            from {
                filter: grayscale(100%);
                color: #ccc;
            }

            to {
                filter: grayscale(0%);
            }
        }

        @keyframes siri-wave-animation {
            0% {
                background-position: 0% 50%;
                transform: scale(1);
            }

            100% {
                background-position: 100% 50%;
                transform: scale(1.02);
            }
        }

        /* Respuestas estructuradas de la IA */
        /* Note: This class is now used for styling content *within* a message, not a standalone div */
        .ai-structured-content {
            background-color: var(--card-background-light-glass); /* Using glass effect for sub-content */
            border-radius: 18px;
            padding: 20px;
            margin-top: 15px; /* Space from previous message */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Lighter shadow for sub-content */
            border: 1px solid var(--border-color-light-glass);
            backdrop-filter: blur(var(--blur-amount));
            animation: fadeIn 0.5s ease forwards;
        }

        body.dark-mode .ai-structured-content {
            background-color: var(--card-background-dark-glass);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color-dark-glass);
        }

        .ai-structured-content h4 {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .ai-structured-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 15px;
        }

        .ai-structured-content ul li {
            background-color: rgba(93, 156, 236, 0.08);
            /* Fondo más sutil para elementos de lista */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: var(--text-light);
            border-left: 4px solid var(--primary-color);
            transition: background-color 0.3s ease;
        }

        body.dark-mode .ai-structured-content ul li {
            background-color: rgba(59, 80, 98, 0.2);
            color: var(--text-dark);
        }

        .ai-structured-content ul li:hover {
            background-color: rgba(93, 156, 236, 0.15);
        }

        body.dark-mode .ai-structured-content ul li:hover {
            background-color: rgba(59, 80, 98, 0.4);
        }

        .ai-structured-content ul li a { /* Keep link styling for potential future use or if user changes mind */
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .ai-structured-content ul li a:hover {
            text-decoration: underline;
        }


        /* Diseño Responsivo */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            /* Re-habilitar el logo y el subtítulo en la cabecera para tablet y móvil si se quiere */
            .logo-text h1,
            .subtitle {
                display: block;
            }

            .logo-text h1 {
                font-size: 2em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .theme-toggle-container {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
            }

            .kpi-section {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .neighborhood-selector {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: center;
                /* Centrar elementos en móvil */
                align-items: center;
                box-shadow: 0 2px 15px var(--shadow-dark);
                /* Sombra más fuerte */
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                border-right: none;
                padding: 15px 20px;
                /* Ajuste padding */
                flex-wrap: wrap;
                /* Permitir que los elementos se envuelvan */
            }

            .sidebar-header {
                margin-bottom: 0;
                font-size: 20px;
                /* Ajuste para móvil */
                width: 100%;
                /* Ocupa todo el ancho */
                justify-content: center;
                /* Centrar el título */
                margin-bottom: 10px;
                /* Espacio debajo */
            }

            .sidebar-header i {
                font-size: 20px;
                /* Ajuste para móvil */
            }

            .sidebar-nav {
                display: none;
                /* Ocultar nav para pantallas pequeñas, se podría añadir un menú hamburguesa */
            }

            .sidebar-footer {
                display: none;
                /* Ocultar footer para pantallas pequeñas */
            }

            .main-content {
                padding: 15px;
            }

            .header {
                align-items: center;
                text-align: center;
                margin-bottom: 20px;
                /* Menos margen */
                flex-direction: column;
                /* Apilar elementos de la cabecera */
            }

            .logo-text {
                flex-direction: column;
                gap: 5px;
                margin-bottom: 15px;
                /* Espacio debajo del logo */
            }

            .logo-text img {
                height: 40px;
                /* Ajuste tamaño logo */
            }

            .logo-text h1,
            .subtitle {
                display: none;
                /* Ocultar el nombre de la app principal en la cabecera en móvil */
            }


            .theme-toggle-container {
                justify-content: center;
                margin-top: 0;
                /* No se necesita margen superior si está en columna */
                width: auto;
                /* Ajustar ancho automáticamente */
            }

            .section-title {
                font-size: 1.6em;
                /* Ajuste para móvil */
                text-align: center;
                justify-content: center;
                margin-bottom: 20px;
            }

            .kpi-card {
                flex-direction: column;
                text-align: center;
                gap: 12px;
                /* Ajuste de espacio */
                padding: 22px;
                /* Ajuste de padding */
                align-items: center;
                /* Centrar elementos en la tarjeta */
            }

            .kpi-card .card-icon {
                font-size: 2.8em;
                /* Ajuste para móvil */
            }

            .kpi-content {
                text-align: center;
            }

            .kpi-value {
                font-size: 2.2em;
                /* Ajuste para móvil */
            }

            .tabs {
                flex-direction: column;
                gap: 10px;
                border-bottom: none;
            }

            .tab {
                width: 100%;
                border-bottom: 2px solid var(--border-color-light-glass);
                border-radius: 10px;
                /* Más redondeado para móviles */
                background-color: var(--card-background-light-glass);
                /* Fondo para tab en móvil */
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                /* Sombra para tabs en móvil */
                backdrop-filter: blur(10px);
            }

            body.dark-mode .tab {
                background-color: var(--card-background-dark-glass);
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }

            .tab.active::after {
                display: none;
                /* No se necesita el borde inferior activo si la tarjeta ya lo tiene */
            }

            .chat-container {
                height: 380px;
                /* Ajuste altura */
                width: 100%;
                /* Ocupar todo el ancho en móvil */
                padding: 15px;
                /* Reducir padding */
            }

            .chat-messages {
                padding: 10px;
                /* Reducir padding */
            }

            .message {
                max-width: 95%;
                padding: 12px 16px;
            }

            .chat-input {
                padding: 15px;
                gap: 8px;
            }

            .chat-input input {
                padding: 12px 18px;
            }

            .chat-input button {
                padding: 12px 20px;
                font-size: 1em;
            }


            .neighborhood-selector {
                grid-template-columns: 1fr;
                gap: 18px;
            }

            .analysis-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .status-badge {
                margin-top: 10px;
            }

            .issue-item,
            .recommendation-item {
                padding: 18px;
                gap: 12px;
                margin-bottom: 12px;
            }

            .recommendation-icon {
                width: 38px;
                height: 38px;
                min-width: 38px;
                min-height: 38px;
                font-size: 1.2em;
            }

            .issue-item h5,
            .recommendation-text h5 {
                font-size: 1.1em;
            }

            .issue-item p,
            .recommendation-text p {
                font-size: 0.95em;
            }
            #event-alert {
                font-size: 0.9em;
                padding: 12px 20px;
                margin-left: 15px;
                margin-right: 15px;
                max-width: calc(100% - 30px); /* Adjust for padding */
                text-align: center; /* Center text on small screens */
            }
            #event-alert i {
                font-size: 1.5em;
            }
            .thinking-process {
                padding: 15px;
                gap: 10px;
            }
            .thinking-process .icons-row {
                gap: 10px;
            }
            .thinking-process .icon-item i {
                font-size: 2em;
            }
            .thinking-process .icon-item p {
                font-size: 0.8em;
            }
            .thinking-message {
                font-size: 0.95em;
                padding: 12px 20px;
                width: 90%;
            }
            /* AI Structured Response is now dynamically added to chat messages */
            .ai-structured-content {
                padding: 15px;
            }
            .ai-structured-content h4 {
                font-size: 1.2em;
            }
            .ai-structured-content ul li {
                font-size: 0.85em;
                padding: 8px 12px;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">
                <img src="logo.png" alt="Logo de CityInsight">
                <!-- Se ha eliminado el h1 y p.subtitle de aquí -->
            </div>
            <h2>CityInsight</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li><a href="medioambiente.html" style="text-decoration: none; color: inherit;"><i
                            class="fas fa-leaf"></i> Medio Ambiente</a></li>
                <li><a href="trafico.html" style="text-decoration: none; color: inherit;"><i class="fas fa-bus"></i>
                        Trafico</a></li>
                <li><a href="ciudadano.html" style="text-decoration: none; color: inherit;"><i
                            class="fas fa-user-friends"></i>
                        <span>Panel Ciudadanos</span></a></li>
                <li><i class="fas fa-cogs"></i> Configuración</li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <span><i class="fas fa-user-circle"></i> Admin</span>
        </div>
    </div>


    <div class="main-content">
        <header class="header">
            
            <div class="theme-toggle-container">
                <button id="theme-toggle">
                    <i id="theme-icon" class="fas fa-moon"></i> Cambiar Tema
                </button>
            </div>
        </header>

        <!-- Nueva Alerta de Evento -->
        <div id="event-alert">
            <div class="event-icon-container">
                <img src="calendario.png" alt="Calendario"> <!-- Placeholder for calendario.png -->
                <span class="event-date-overlay">20</span>
            </div>
            <p>Europa League</p>
        </div>


        <!-- Indicadores Clave -->
        <h2 class="section-title"><i class="fas fa-chart-line"></i> Indicadores Clave de Rendimiento</h2>
        <section class="kpi-section">
            <div class="kpi-card" data-kpi="Índice de Calidad Urbana">
                <i class="fas fa-leaf card-icon"></i>
                <div class="kpi-content">
                    <h3>Índice de Calidad Urbana</h3>
                    <p class="kpi-value">78.3/100</p>
                    <div class="kpi-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>2.4% vs mes anterior</span>
                    </div>
                    <button class="kpi-info-btn">Ver detalles</button>
                </div>
            </div>
            <div class="kpi-card" data-kpi="Zonas Verdes">
                <i class="fas fa-tree card-icon"></i>
                <div class="kpi-content">
                    <h3>Zonas Verdes</h3>
                    <p class="kpi-value">16.5 m²/hab</p>
                    <div class="kpi-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>0.8% vs mes anterior</span>
                    </div>
                </div>
                <button class="kpi-info-btn">Ver detalles</button>
            </div>
            <div class="kpi-card" data-kpi="Intensidad de Tráfico">
                <i class="fas fa-car-side card-icon"></i>
                <div class="kpi-content">
                    <h3>Intensidad de Tráfico</h3>
                    <p class="kpi-value">63.2%</p>
                    <div class="kpi-trend negative">
                        <i class="fas fa-arrow-down"></i>
                        <span>1.7% vs mes anterior</span>
                    </div>
                </div>
                <button class="kpi-info-btn">Ver detalles</button>
            </div>
            <div class="kpi-card" data-kpi="Satisfacción Ciudadana">
                <i class="fas fa-smile card-icon"></i>
                <div class="kpi-content">
                    <h3>Satisfacción Ciudadana</h3>
                    <p class="kpi-value">82%</p>
                    <div class="kpi-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>3.5% vs mes anterior</span>
                    </div>
                </div>
                <button class="kpi-info-btn">Ver detalles</button>
            </div>
        </section>

        <!-- Sección de Análisis IA -->
        <h2 class="section-title"><i class="fas fa-robot"></i> Análisis Inteligente</h2>

        <div class="tabs">
            <button class="tab active" data-tab="chat">Chat con IA</button>
            <button class="tab" data-tab="neighborhood">Análisis por Barrio</button>
        </div>


        <div id="chat-tab" class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages">
                    <div class="message ai-message">
                        Hola, soy CityInsight. ¿En qué puedo ayudarte hoy con la gestión municipal? Puedo analizar datos
                        urbanos, recomendar mejoras o responder preguntas sobre desarrollo urbano sostenible.
                    </div>
                </div>
                <div class="thinking-process" style="display: none;">
                    <div class="icons-row">
                        <div class="icon-item" data-source="ayuntamiento"><i class="fas fa-building"></i><p>Datos del Ayuntamiento</p></div>
                        <div class="icon-item" data-source="redes-sociales"><i class="fa-brands fa-instagram"></i>"></i><p>Redes Sociales</p></div>
                        <div class="icon-item" data-source="ciudadanos"><i class="fas fa-users"></i><p>Datos Ciudadanos</p></div>
                    </div>
                    <div class="thinking-message"></div>
                </div>
                <div class="chat-input">
                    <img src="Diseño sin título (1).png" alt="AI Avatar" class="ai-avatar" id="ai-avatar-image">
                    <input type="text" placeholder="Escribe tu mensaje aquí..." id="chat-input-field">
                    <button id="send-button">
                        <img src="enviar-mensaje.png" alt="Enviar" class="send-icon">
                    </button>
                     <div class="ai-avatar-tooltip">Soy tu IA, estoy aquí para ayudarte</div>
                </div>
            </div>
        </div>



        <div id="neighborhood-tab" class="tab-content">
            <h3>Selecciona un barrio para ver el análisis</h3>
            <div class="neighborhood-selector">
                <div class="neighborhood-card" data-neighborhood="centro">
                    <div class="neighborhood-icon">🏙️</div>
                    <h4>Centro Histórico</h4>
                </div>
                <div class="neighborhood-card" data-neighborhood="norte">
                    <div class="neighborhood-icon">🏡</div>
                    <h4>Zona Norte</h4>
                </div>
                <div class="neighborhood-card" data-neighborhood="este">
                    <div class="neighborhood-icon">🌆</div>
                    <h4>Distrito Este</h4>
                </div>
                <div class="neighborhood-card" data-neighborhood="sur">
                    <div class="neighborhood-icon">🏘️</div>
                    <h4>Barrio Sur</h4>
                </div>
            </div>

            <div id="analysis-centro" class="analysis-container">
                <div class="analysis-header">
                    <div class="analysis-title">
                        <h3>Análisis: Centro Histórico</h3>
                        <p>Última actualización: 23 de mayo, 2023</p>
                    </div>
                    <span class="status-badge">2 problemas detectados</span>
                </div>

                <div class="issues-list">
                    <h4>Problemas Detectados</h4>
                    <div class="issue-item">
                        <h5>Escasez de espacios verdes</h5>
                        <p>Se ha detectado una proporción de espacios verdes por habitante inferior al 15% recomendado
                            por
                            la OMS.
                            El Centro Histórico cuenta actualmente con solo un 7% de espacios verdes accesibles.</p>
                    </div>
                    <div class="issue-item">
                        <h5>Alta congestión vehicular</h5>
                        <p>Los datos de tráfico muestran una saturación en las principales vías durante el 65% de las
                            horas
                            laborables.</p>
                    </div>
                </div>

                <div class="recommendations">
                    <h4>Recomendaciones de la IA</h4>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">1</div>
                        <div class="recommendation-text">
                            <h5>Implementación de parques de bolsillo</h5>
                            <p>Transformar pequeños espacios infrautilizados en mini parques. Se han identificado 12
                                ubicaciones
                                potenciales.</p>
                        </div>
                    </div>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">2</div>
                        <div class="recommendation-text">
                            <h5>Peatonalización selectiva</h5>
                            <p>Convertir calles secundarias en zonas peatonales con vegetación para mejorar la calidad
                                del
                                aire.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-norte" class="analysis-container">
                <div class="analysis-header">
                    <div class="analysis-title">
                        <h3>Análisis: Zona Norte</h3>
                        <p>Última actualización: 25 de mayo, 2023</p>
                    </div>
                    <span class="status-badge">1 problemas detectados</span>
                </div>

                <div class="issues-list">
                    <h4>Problemas Detectados</h4>
                    <div class="issue-item">
                        <h5>Falta de parques infantiles</h5>
                        <p>A pesar de ser una zona con alta densidad de familias, la Zona Norte cuenta con solo 2
                            parques
                            infantiles
                            para una población de más de 15,000 menores de 12 años.</p>
                    </div>
                </div>

                <div class="recommendations">
                    <h4>Recomendaciones de la IA</h4>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">1</div>
                        <div class="recommendation-text">
                            <h5>Plan de parques multifuncionales</h5>
                            <p>Desarrollar tres nuevos parques que integren zonas infantiles y áreas deportivas.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-este" class="analysis-container">
                <div class="analysis-header">
                    <div class="analysis-title">
                        <h3>Análisis: Distrito Este</h3>
                        <p>Última actualización: 20 de mayo, 2023</p>
                    </div>
                    <span class="status-badge">1 problemas detectados</span>
                </div>

                <div class="issues-list">
                    <h4>Problemas Detectados</h4>
                    <div class="issue-item">
                        <h5>Parques mal distribuidos</h5>
                        <p>Aunque el distrito cumple con la ratio de zona verde por habitante, el 80% de estos espacios
                            están concentrados en el sector norte.</p>
                    </div>
                </div>

                <div class="recommendations">
                    <h4>Recomendaciones de la IA</h4>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">1</div>
                        <div class="recommendation-text">
                            <h5>Creación de microparques en el sur</h5>
                            <p>Implementar una red de pequeños parques en plazoletas y solares disponibles.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-sur" class="analysis-container">
                <div class="analysis-header">
                    <div class="analysis-title">
                        <h3>Análisis: Barrio Sur</h3>
                        <p>Última actualización: 22 de mayo, 2023</p>
                    </div>
                    <span class="status-badge">1 problemas detectados</span>
                </div>

                <div class="issues-list">
                    <h4>Problemas Detectados</h4>
                    <div class="issue-item">
                        <h5>Grave déficit de zonas verdes</h5>
                        <p>Con solo un 3% de superficie verde, el Barrio Sur presenta el mayor déficit de la ciudad.</p>
                    </div>
                </div>

                <div class="recommendations">
                    <h4>Recomendaciones de la IA</h4>
                    <div class="recommendation-item">
                        <div class="recommendation-icon">1</div>
                        <div class="recommendation-text">
                            <h5>Creación de un parque central</h5>
                            <p>Reconvertir la antigua zona industrial en un gran parque urbano de 5 hectáreas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para cambiar entre modo claro y oscuro
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // Función de cambio de tema
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeIcon.classList.toggle('fa-sun', isDarkMode);
            themeIcon.classList.toggle('fa-moon', !isDarkMode);
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        }

        // Verificar el estado del modo nocturno al cargar la página
        window.addEventListener('load', () => {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                themeIcon.classList.add('fa-sun');
                themeIcon.classList.remove('fa-moon');
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.classList.add('fa-moon');
                themeIcon.classList.remove('fa-sun');
            }
        });

        // Añadir evento de clic al botón de cambio de tema
        themeToggle.addEventListener('click', toggleTheme);

        // Lógica de pestañas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Quitar la clase activa de todas las pestañas y ocultar todos los contenidos de las pestañas
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

                // Añadir la clase activa a la pestaña clicada y mostrar su contenido
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');

                // Si se cambia a la pestaña de chat, restablecer el contenido del chat
                if (tab.dataset.tab === 'chat') {
                    const chatMessages = document.querySelector('.chat-messages');
                    chatMessages.innerHTML = `<div class="message ai-message">
                        Hola, soy CityInsight. ¿En qué puedo ayudarte hoy con la gestión municipal? Puedo analizar datos
                        urbanos, recomendar mejoras o responder preguntas sobre desarrollo urbano sostenible.
                    </div>`;
                    // Ocultar el proceso de pensamiento y las respuestas estructuradas si estaban visibles
                    thinkingProcess.style.display = 'none';
                    document.querySelectorAll('.thinking-process .icon-item').forEach(icon => icon.classList.remove('colored'));
                }

                // Si se cambia a la pestaña de barrios, restablecer la selección de barrio
                if (tab.dataset.tab === 'neighborhood') {
                    document.querySelectorAll('.neighborhood-card').forEach(c => c.classList.remove('selected'));
                    document.querySelectorAll('.analysis-container').forEach(container => {
                        container.style.display = 'none';
                    });
                }
            });
        });

        // Lógica de chatbot
        const chatInputField = document.getElementById('chat-input-field');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.querySelector('.chat-messages');
        const thinkingProcess = document.querySelector('.thinking-process');
        const thinkingMessage = document.querySelector('.thinking-message');
        const eventAlert = document.getElementById('event-alert');
        const aiAvatarImage = document.getElementById('ai-avatar-image'); // Get AI avatar image element

        // Función para simular el efecto de escritura (no se usará para el mensaje final)
        async function typeMessage(element, text, delay = 20) {
            // Create a temporary span to hold the typing text
            const typingSpan = document.createElement('span');
            element.appendChild(typingSpan);
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            for (let i = 0; i < text.length; i++) {
                typingSpan.textContent += text.charAt(i);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Keep scrolling down
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        // Definimos las respuestas específicas para cada KPI
        const kpiResponses = {
            "Índice de Calidad Urbana": "El Índice de Calidad Urbana de 78.3 sobre 100 refleja una tendencia positiva del 2.4% con respecto al mes anterior. Este índice es una métrica integral que evalúa la calidad de vida en la ciudad basándose en factores clave como la disponibilidad de espacios verdes, la eficiencia del transporte público, la calidad del aire y la accesibilidad a servicios esenciales. La mejora actual se atribuye principalmente a recientes iniciativas de reducción de ruido urbano y la creación de nuevas zonas peatonales, que han contribuido a un entorno más agradable para los ciudadanos. Se prevé que esta tendencia continúe con los proyectos de infraestructura sostenible en curso.",
            "Zonas Verdes": "La ciudad cuenta con un promedio de 16.5 metros cuadrados de zonas verdes por habitante, superando holgadamente el estándar de 9 metros cuadrados por habitante recomendado por la Organización Mundial de la Salud. No obstante, un análisis más profundo revela que el 65% de los barrios aún presenta una distribución desequilibrada, con menos de 12 metros cuadrados por habitante en algunas áreas. Para abordar esta disparidad, CityInsight recomienda enfáticamente la implementación de 'parques de bolsillo' en zonas deficitarias, utilizando pequeños terrenos infrautilizados para crear micro-oasis urbanos que mejoren el acceso a la naturaleza en proximidad a los hogares.",
            "Intensidad de Tráfico": "La Intensidad de Tráfico se sitúa actualmente en un 63.2% de saturación, lo que representa un ligero incremento del 1.7% en comparación con el mes anterior. Este aumento se atribuye a la reactivación económica y el retorno gradual a la presencialidad post-pandemia. Para mitigar esta situación y evitar futuras congestiones, el ayuntamiento está impulsando activamente el uso del transporte público mediante mejoras en la frecuencia y cobertura de rutas, así como la expansión de la red de carriles bici. También se están evaluando medidas de gestión del flujo vehicular mediante sistemas de semáforos inteligentes para optimizar el tráfico en horas punta.",
            "Satisfacción Ciudadana": "El nivel de Satisfacción Ciudadana alcanza un sólido 82%, lo que indica una percepción generalmente positiva de los servicios municipales. Este porcentaje ha experimentado un aumento del 3.5% respecto al mes anterior, reflejando el impacto de iniciativas recientes en diversas áreas. Las encuestas revelan que los servicios de limpieza y seguridad pública son las áreas de mayor satisfacción, donde los ciudadanos aprecian los esfuerzos constantes del ayuntamiento. Sin embargo, la movilidad urbana sigue siendo un desafío, y se están planificando nuevas estrategias para mejorar la fluidez del tráfico y la accesibilidad del transporte en toda la ciudad.",
            "evento de limpieza urbana": {
                problem: "Se ha identificado que, a pesar de los esfuerzos continuos del departamento de limpieza, persisten problemas de acumulación de residuos en ciertas áreas de la ciudad. Esto es particularmente notorio después de eventos públicos masivos o en zonas de alta afluencia peatonal, donde la capacidad de gestión de residuos se ve superada. Esta situación no solo degrada la imagen urbana, sino que también genera preocupación entre los ciudadanos sobre la higiene y la calidad de vida en sus barrios. La causa raíz parece ser una combinación de falta de concienciación ciudadana y una optimización mejorable en la infraestructura de recogida de residuos en puntos específicos.",
                solutions: [
                    "Optimización de Rutas y Frecuencia de Recogida: Rediseñar las rutas de los camiones de basura y aumentar la frecuencia de recogida en zonas problemáticas, especialmente durante fines de semana o eventos. Esto podría incluir la instalación de puntos de recogida adicionales o la adaptación de horarios.",
                    "Campaña de Concienciación Ciudadana: Lanzar una campaña educativa y de sensibilización a gran escala sobre la importancia del reciclaje y la correcta disposición de residuos. Se podrían usar infografías, talleres comunitarios y mensajes en redes sociales para fomentar la participación.",
                    "Implementación de Contenedores Inteligentes: Instalar contenedores con sensores que alerten a los servicios de limpieza cuando estén cerca de su capacidad máxima. Esto permitiría una recogida más eficiente y evitaría el desbordamiento de basura en las calles.",
                    "Refuerzo de Equipos de Limpieza en Puntos Críticos: Desplegar equipos de limpieza adicionales y de respuesta rápida en áreas identificadas con alta acumulación de basura, como mercados, parques y zonas de ocio, para mantener la limpieza constante y visible."
                ]
            }
        };

        async function sendMessage() {
            const messageText = chatInputField.value.trim();
            if (messageText === '') return;

            // Mostrar mensaje del usuario
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('message', 'user-message');
            userMessageDiv.textContent = messageText;
            chatMessages.appendChild(userMessageDiv);

            chatInputField.value = ''; // Limpiar campo de entrada
            chatMessages.scrollTop = chatMessages.scrollHeight; // Desplazar hasta abajo

            // Start AI avatar spin animation
            aiAvatarImage.classList.add('spinning');
            
            // Hide thinking process if it was visible
            thinkingProcess.style.display = 'none';

            // Show thinking process
            thinkingProcess.style.display = 'flex';
            const thinkingIcons = document.querySelectorAll('.thinking-process .icon-item');
            thinkingIcons.forEach(icon => icon.classList.remove('colored')); // Reset colors

            const thinkingMessagesData = [
                { icon: thinkingIcons[0], text: 'Analizando datos del ayuntamiento' },
                { icon: thinkingIcons[1], text: 'Analizando redes sociales' },
                { icon: thinkingIcons[2], text: 'Analizando datos ciudadanos' }
            ];

            // Animate thinking messages and color icons
            for (let i = 0; i < thinkingMessagesData.length; i++) {
                thinkingMessage.textContent = thinkingMessagesData[i].text;
                thinkingMessagesData[i].icon.classList.add('colored');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2 seconds per message/icon
            }

            // Final thinking message before response appears
            thinkingMessage.textContent = "Generando respuesta...";
            chatMessages.scrollTop = chatMessages.scrollHeight;
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second for "generating response"


            // Hide thinking process
            thinkingProcess.style.display = 'none';
            thinkingIcons.forEach(icon => icon.classList.remove('colored')); // Reset icons for next time

            // Stop AI avatar spin animation
            aiAvatarImage.classList.remove('spinning');


            // Get AI response
            let aiResponseContent = "";
            let structuredResponseData = null;

            const lowerCaseMessage = messageText.toLowerCase();

            if (lowerCaseMessage.includes("evento") && lowerCaseMessage.includes("limpieza urbana")) {
                structuredResponseData = kpiResponses["evento de limpieza urbana"];
            } else {
                const kpiKey = Object.keys(kpiResponses).find(kpi => lowerCaseMessage.includes(kpi.toLowerCase()));
                if (kpiKey) {
                    aiResponseContent = kpiResponses[kpiKey];
                } else {
                    aiResponseContent = "Actualmente, solo puedo proporcionar información detallada sobre los KPIs predefinidos o el evento de limpieza urbana. Por favor, intenta preguntar sobre uno de ellos (Ej: 'Háblame del Índice de Calidad Urbana' o 'Información sobre el evento de limpieza urbana').";
                }
            }

            // Display AI message instantly
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.classList.add('message', 'ai-message');
            chatMessages.appendChild(aiMessageDiv); // Append empty div first

            if (structuredResponseData) {
                const problemHtml = `<h4>Problema Encontrado</h4><ul><li>${structuredResponseData.problem}</li></ul>`;
                const solutionsHtml = `<h4>Posibles Soluciones</h4><ul>${structuredResponseData.solutions.map(sol => `<li>${sol}</li>`).join('')}</ul>`;
                
                const fullContentHtml = `<div class="ai-structured-content">${problemHtml}${solutionsHtml}</div>`;
                aiMessageDiv.innerHTML = fullContentHtml; // Set content directly
            } else {
                aiMessageDiv.textContent = aiResponseContent; // Set content directly
            }

            chatMessages.scrollTop = chatMessages.scrollHeight; // Final scroll to bottom
        }

        sendButton.addEventListener('click', sendMessage);
        chatInputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Clic en el botón KPI para activar el chat y enviar una consulta específica
        document.querySelectorAll('.kpi-info-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const kpiCard = event.target.closest('.kpi-card');
                const kpiName = kpiCard.dataset.kpi;

                // Activar pestaña de chat
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                document.querySelector('.tab[data-tab="chat"]').classList.add('active');
                document.getElementById('chat-tab').classList.add('active');

                // Enviar un mensaje predefinido al chat
                const queryMessage = `Quiero saber más sobre ${kpiName}`;
                chatInputField.value = queryMessage;
                // No automatically send, user clicks send button
                // sendMessage(); 

                // Desplazarse al contenedor del chat
                document.querySelector('.chat-container').scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Event listener for the event alert
        eventAlert.addEventListener('click', () => {
            // Activate chat tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelector('.tab[data-tab="chat"]').classList.add('active');
            document.getElementById('chat-tab').classList.add('active');

            // Pre-fill chat input with event query, but don't send automatically
            chatInputField.value = "Información sobre el evento de limpieza urbana";
            // Scroll to chat container
            document.querySelector('.chat-container').scrollIntoView({ behavior: 'smooth' });

            // No automatic send
        });


        // Selección de barrio
        document.querySelectorAll('.neighborhood-card').forEach(card => {
            card.addEventListener('click', () => {
                // Quitar la clase seleccionada de todas las tarjetas de barrio
                document.querySelectorAll('.neighborhood-card').forEach(c => c.classList.remove('selected'));
                // Añadir la clase seleccionada a la tarjeta clicada
                card.classList.add('selected');

                // Ocultar todos los contenedores de análisis
                document.querySelectorAll('.analysis-container').forEach(container => {
                    container.style.display = 'none';
                });

                // Mostrar el análisis del barrio seleccionado con animación
                const analysisContainer = document.getElementById(`analysis-${card.dataset.neighborhood}`);
                if (analysisContainer) {
                    analysisContainer.style.display = 'block';
                    // Desplazarse al contenedor de análisis con animación suave
                    analysisContainer.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Añadir animación a las tarjetas KPI al cargar
        document.addEventListener('DOMContentLoaded', function () {
            const kpiCards = document.querySelectorAll('.kpi-card');
            kpiCards.forEach((card, index) => {
                card.style.animation = `fadeIn 0.7s ease forwards ${index * 0.1}s`;
                /* Ligeramente más lento */
                card.style.opacity = '0';
                /* Asegurar que comiencen ocultas */
            });
        });
    </script>
</body>

</html>
